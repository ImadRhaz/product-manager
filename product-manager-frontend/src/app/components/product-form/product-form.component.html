<h2>{{ isEditMode ? 'Modifier Produit' : 'Créer un Produit' }}</h2>

<!-- Affiche un message d'erreur s'il y en a -->
<div *ngIf="error" class="alert alert-danger" role="alert">
  {{ error }}
</div>

<!-- Le formulaire doit être dans un <form> tag pour que l'upload fonctionne bien avec formData -->
<form [formGroup]="productForm" (ngSubmit)="onSubmit()" enctype="multipart/form-data">

  <!-- Champs communs -->
  <div class="mb-3">
    <label for="nom" class="form-label">Nom du produit<span class="text-danger">*</span></label>
    <input type="text" id="nom" formControlName="nom" class="form-control" [ngClass]="{'is-invalid': productForm.get('nom')?.invalid && (productForm.get('nom')?.dirty || productForm.get('nom')?.touched)}">
    <!-- Message d'erreur pour le champ 'nom' -->
    <div *ngIf="productForm.get('nom')?.invalid && (productForm.get('nom')?.dirty || productForm.get('nom')?.touched)" class="invalid-feedback">
      Le nom est obligatoire et doit faire moins de 100 caractères.
    </div>
  </div>

  <div class="mb-3">
    <label for="prix" class="form-label">Prix<span class="text-danger">*</span></label>
    <input type="number" id="prix" formControlName="prix" class="form-control" [ngClass]="{'is-invalid': productForm.get('prix')?.invalid && (productForm.get('prix')?.dirty || productForm.get('prix')?.touched)}">
    <!-- Message d'erreur pour le champ 'prix' -->
    <div *ngIf="productForm.get('prix')?.invalid && (productForm.get('prix')?.dirty || productForm.get('prix')?.touched)" class="invalid-feedback">
      Le prix est obligatoire et doit être supérieur à 0.
    </div>
  </div>

  <div class="mb-3">
    <label for="categorie" class="form-label">Catégorie<span class="text-danger">*</span></label>
    <!-- Utilise un <select> pour choisir la catégorie -->
    <!-- L'événement (change) appelle onCategoryChange pour mettre à jour les validateurs conditionnels -->
    <select id="categorie"
            formControlName="categorie"
            class="form-select"
            [ngClass]="{'is-invalid': productForm.get('categorie')?.invalid && (productForm.get('categorie')?.dirty || productForm.get('categorie')?.touched)}"
            (change)="onCategoryChange(productForm.get('categorie')?.value)">
      <option value="">-- Sélectionnez une catégorie --</option>
      <option value="Informatique">Informatique</option>
      <option value="Véhicule">Véhicule</option>
      <option value="Alimentaire">Alimentaire</option>
      <!-- Ajoute d'autres catégories si nécessaire -->
    </select>
    <!-- Message d'erreur pour le champ 'categorie' -->
    <div *ngIf="productForm.get('categorie')?.invalid && (productForm.get('categorie')?.dirty || productForm.get('categorie')?.touched)" class="invalid-feedback">
      La catégorie est obligatoire.
    </div>
  </div>

  <!-- Champs conditionnels -->
  <!-- Référence (pour Informatique) -->
  <!-- Le champ est affiché seulement si la catégorie est 'Informatique' -->
  <div class="mb-3" *ngIf="isFieldVisible('reference')">
    <label for="reference" class="form-label">Référence</label>
    <input type="text" id="reference" formControlName="reference" class="form-control" [ngClass]="{'is-invalid': productForm.get('reference')?.invalid && (productForm.get('reference')?.dirty || productForm.get('reference')?.touched)}">
    <!-- Message d'erreur pour la référence -->
    <div *ngIf="productForm.get('reference')?.invalid && (productForm.get('reference')?.dirty || productForm.get('reference')?.touched)" class="invalid-feedback">
      La référence est obligatoire pour Informatique.
    </div>
  </div>

  <!-- Matricule (pour Véhicule) -->
  <div class="mb-3" *ngIf="isFieldVisible('matricule')">
    <label for="matricule" class="form-label">Matricule</label>
    <input type="text" id="matricule" formControlName="matricule" class="form-control" [ngClass]="{'is-invalid': productForm.get('matricule')?.invalid && (productForm.get('matricule')?.dirty || productForm.get('matricule')?.touched)}">
    <!-- Message d'erreur pour le matricule -->
    <div *ngIf="productForm.get('matricule')?.invalid && (productForm.get('matricule')?.dirty || productForm.get('matricule')?.touched)" class="invalid-feedback">
      Le matricule est obligatoire pour Véhicule.
    </div>
  </div>

  <!-- Date d'expiration (pour Alimentaire) -->
  <div class="mb-3" *ngIf="isFieldVisible('dateExpiration')">
    <label for="dateExpiration" class="form-label">Date d'expiration</label>
    <input type="date" id="dateExpiration" formControlName="dateExpiration" class="form-control" [ngClass]="{'is-invalid': productForm.get('dateExpiration')?.invalid && (productForm.get('dateExpiration')?.dirty || productForm.get('dateExpiration')?.touched)}">
    <!-- Message d'erreur pour la date d'expiration -->
    <div *ngIf="productForm.get('dateExpiration')?.invalid && (productForm.get('dateExpiration')?.dirty || productForm.get('dateExpiration')?.touched)" class="invalid-feedback">
      La date d'expiration est obligatoire pour Alimentaire.
    </div>
  </div>

  <!-- Upload de fichier -->
  <div class="mb-3">
    <label class="form-label">Gestion du fichier</label>
    
    <!-- Affichage du fichier actuel en mode édition -->
    <div *ngIf="isEditMode && currentProduct?.fileName" class="current-file mb-2 p-2 bg-light rounded">
      <strong>{{ getCurrentFileName() }}</strong>
      <button type="button" class="btn btn-outline-danger btn-sm ms-2" (click)="removeFile()" *ngIf="hasNewFile">
        Annuler
      </button>
    </div>

    <!-- Input pour la sélection de fichier -->
    <label for="file" class="form-label">{{ isEditMode ? 'Changer le fichier' : 'Fichier associé' }}</label>
    <input type="file" id="file" (change)="onFileSelected($event)" class="form-control" accept="image/*,.pdf,.doc,.docx,.txt">
    
    <!-- Affiche le nom du fichier sélectionné s'il y en a un -->
    <div *ngIf="selectedFileName && hasNewFile" class="text-success mt-1">
      <small>Nouveau fichier sélectionné : {{ selectedFileName }}</small>
    </div>

    <!-- Prévisualisation de l'image -->
    <div *ngIf="imageUrl" class="mt-3">
      <label class="form-label">Aperçu :</label>
      <div>
        <!-- Aperçu pour les images -->
        <img *ngIf="imageUrl && (imageUrl.startsWith('data:') || imageUrl.includes('/api/produits/files/'))" 
             [src]="imageUrl" alt="Aperçu du fichier" 
             class="img-thumbnail" 
             style="max-width: 200px; max-height: 200px;">
        
        <!-- Message pour les fichiers non visualisables -->
        <div *ngIf="imageUrl && !imageUrl.startsWith('data:') && !imageUrl.includes('/api/produits/files/')" 
             class="alert alert-info mt-2">
          <i class="fas fa-file"></i> Fichier non visualisable (PDF, document, etc.)
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="form-text">
      Types de fichiers acceptés : images, PDF, Word, texte. Taille maximale : 10MB.
    </div>
  </div>

  <!-- Boutons de soumission -->
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary" [disabled]="!productForm.valid">
      {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
    </button>
<button type="button" class="btn btn-secondary" (click)="onCancel()">Annuler</button>
  </div>

</form>
